/*
 Apache License, Version 2.0.
*/
var xh=xh||{};xh.SHIFT_KEYCODE=16;xh.X_KEYCODE=88;xh.analytics=function(a){chrome.runtime.sendMessage({type:"analytics",data:a})};xh.elementsShareFamily=function(a,c){return a.tagName===c.tagName&&(!a.className||a.className===c.className)&&(!a.id||a.id===c.id)};
xh.getElementIndex=function(a){var c=1,b;for(b=a.previousSibling;b;b=b.previousSibling)b.nodeType===Node.ELEMENT_NODE&&xh.elementsShareFamily(a,b)&&c++;if(1<c)return c;for(b=a.nextSibling;b;b=b.nextSibling)if(b.nodeType===Node.ELEMENT_NODE&&xh.elementsShareFamily(a,b))return 1;return 0};xh.isUnique=function(a){a=document.evaluate(a,document,null,XPathResult.ANY_TYPE,null);for(var c=0,b=a.iterateNext();b;)c+=1,b=a.iterateNext();return 1===c};
xh.getTopTwo=function(a){a=document.evaluate(a,document,null,XPathResult.ANY_TYPE,null);var c,b;(c=a.iterateNext())&&(b=a.iterateNext());return b?[c,b]:!1};
xh.makeQueryForElement=function(a,c){for(var b="";a&&a.nodeType===Node.ELEMENT_NODE;a=a.parentNode){var d=a.tagName.toLowerCase(),g=xh.getElementIndex(a);if(c.minimal&&xh.isUnique("//"+d+b)){b="//"+d+b;break}if(a.id.trim())d+="[@id='"+a.id.trim()+"']";else if(a.className.trim()){var f=a.className.trim();if(void 0!==c.ignore)for(var h=c.ignore.split(" "),e=0;e<h.length;e++)f=f.replace(h[e],"").trim();""!==f&&(d+="[contains(@class, '"+f+"')]")}if(c.minimal&&xh.isUnique("//"+d+b)){b="//"+d+b;break}f=
d;1<=g&&(d+="["+g+"]");if(c.minimal&&xh.isUnique("//"+d+b)){b=c.similar?"//"+f+b:"//"+d+b;break}""===b&&"img"===a.tagName.toLowerCase()&&(d+="/@src");b="/"+d+b;if(c.minimal&&xh.isUnique("/"+b)){b="//"+d+b;break}}if(c.minimal&&void 0!==c.parent){for(e=0;e<b.length&&e<c.parent.length&&b[e]===c.parent[e];e++);b=b.substr(e+1)}return b};xh.highlight=function(a){for(var c=0,b=a.length;c<b;c++)a[c].classList.add("xh-highlight")};
xh.clearHighlights=function(){for(var a=document.querySelectorAll(".xh-highlight"),c=0,b=a.length;c<b;c++)a[c].classList.remove("xh-highlight")};
xh.evaluateQuery=function(a){var c=null,b="",d=0,g=[];try{c=document.evaluate(a,document,null,XPathResult.ANY_TYPE,null)}catch(f){b="[INVALID XPATH EXPRESSION]",d=0}if(!c)return[b,d];if(c.resultType===XPathResult.BOOLEAN_TYPE)b=c.booleanValue?"1":"0",d=1;else if(c.resultType===XPathResult.NUMBER_TYPE)b=c.numberValue.toString(),d=1;else if(c.resultType===XPathResult.STRING_TYPE)b=c.stringValue,d=1;else if(c.resultType===XPathResult.UNORDERED_NODE_ITERATOR_TYPE){for(a=c.iterateNext();a;a=c.iterateNext())a.nodeType===
Node.ELEMENT_NODE&&g.push(a),b&&(b+="\n"),b+=a.textContent,d++;0===d&&(b="[NULL]")}else b="[INTERNAL ERROR]",d=0;xh.highlight(g);return[b,d]};
xh.Bar=function(){this.boundHandleRequest_=this.handleRequest_.bind(this);this.boundMouseMove_=this.mouseMove_.bind(this);this.boundKeyDown_=this.keyDown_.bind(this);this.opt_={};this.opt_.minimal=!0;this.opt_.similar=!0;this.inDOM_=!1;this.currEl_=null;this.barFrame_=document.createElement("iframe");this.barFrame_.src=chrome.runtime.getURL("bar.html");this.barFrame_.id="xh-bar";this.barFrame_.classList.add("hidden");document.addEventListener("keydown",this.boundKeyDown_);chrome.runtime.onMessage.addListener(this.boundHandleRequest_)};
xh.Bar.prototype.hidden_=function(){return this.barFrame_.classList.contains("hidden")};xh.Bar.prototype.updateQueryAndBar_=function(a){xh.clearHighlights();this.query_=a?xh.makeQueryForElement(a,this.opt_):"";this.updateBar_(!0)};xh.Bar.prototype.updateBar_=function(a){var c;c=void 0===this.opt_.parent?this.query_:this.opt_.parent+"/"+this.query_;c=this.query_?xh.evaluateQuery(c):["",0];chrome.runtime.sendMessage({type:"update",query:a?this.query_:null,results:c})};
xh.Bar.prototype.showBar_=function(){var a=this;this.inDOM_||(this.inDOM_=!0,document.body.appendChild(this.barFrame_));window.setTimeout(function(){a.barFrame_.classList.remove("hidden");document.addEventListener("mousemove",a.boundMouseMove_);a.updateBar_(!0)},0)};xh.Bar.prototype.hideBar_=function(){var a=this;window.setTimeout(function(){a.barFrame_.classList.add("hidden");document.removeEventListener("mousemove",a.boundMouseMove_);xh.clearHighlights()},0)};
xh.Bar.prototype.toggleBar_=function(){this.hidden_()?(xh.analytics(["_trackEvent","ui","bar","show"]),this.showBar_()):(xh.analytics(["_trackEvent","ui","bar","hide"]),this.hideBar_())};xh.Bar.prototype.getParent_=function(){xh.analytics(["_trackEvent","ui","get_parent"]);var a=xh.getTopTwo(this.query_);console.log(a);a=utilityFn.getCommonRoot(a[0],a[1]);console.log(a);a=xh.makeQueryForElement(a,{minimal:!0,similar:!0});console.log(a);chrome.runtime.sendMessage({type:"setParent",parent:a})};
xh.Bar.prototype.handleRequest_=function(a,c,b){"evaluate"===a.type?(xh.clearHighlights(),this.query_=a.query,this.opt_=a,this.updateBar_(!1)):"moveBar"===a.type?this.barFrame_.classList.toggle("bottom"):"hideBar"===a.type?(this.hideBar_(),window.focus()):"toggleBar"===a.type?this.toggleBar_():"getParent"===a.type&&this.getParent_()};xh.Bar.prototype.mouseMove_=function(a){this.currEl_!==a.toElement&&(this.currEl_=a.toElement,a.shiftKey&&this.updateQueryAndBar_(this.currEl_))};
xh.Bar.prototype.keyDown_=function(a){var c=a.ctrlKey||a.metaKey,b=a.shiftKey;xh.analytics(["_trackEvent","run",void 0===this.opt_.parent?"root":"has_parent"]);a.keyCode===xh.X_KEYCODE&&c&&b&&this.toggleBar_();this.hidden_()||c||a.keyCode!==xh.SHIFT_KEYCODE||this.updateQueryAndBar_(this.currEl_)};-1===location.href.indexOf("acid3.acidtests.org")&&(window.xhBarInstance=new xh.Bar);
